TestBrowserChromeAV:
  Roles:
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-fake-ui-for-media-stream
            - use-fake-device-for-media-stream
            - no-sandbox
            # - use-file-for-fake-audio-capture=/user/silence.wav
            # - use-file-for-fake-video-capture=/Users/user/Downloads/1080p-5fps.mjpeg
      App: desktop
  Actions:
    - Type: navigate
      Role: desktopChrome
      Value: https://webcamtests.com/
    - Type: click
      Strategy: id
      Role: desktopChrome
      Id: webcam-launcher
    - Type: sleep
      Time: 10

NavigateToAppr:
  Step: I navigate to appr page
  Roles:
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-fake-ui-for-media-stream
            - use-fake-device-for-media-stream
            - no-sandbox
      App: desktop
  Actions:
    - Type: navigate
      Role: desktopChrome
      Value: https://appr.tc/

CreateRoomAppr:
  Step: I create a room
  Roles:
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-fake-ui-for-media-stream
            - use-fake-device-for-media-stream
            - no-sandbox
      App: desktop
  Actions:
    - Type: get_attribute
      Strategy: css
      Id: "[id=\"room-id-input\"]"
      Greps:
        - var: LINK_ID
          attr: value
          condition: nempty
          match: "(.*)"
    - Type: click
      Strategy: css
      Id: "[id=\"join-button\"]"
      Role: desktopChrome
    - Type: click
      Strategy: xpath
      Id: //body
    - Type: click
      Strategy: id
      Id: mute-audio
    - Type: maximize
      Width: 576
      Height: 1300


JoinApprRoom:
  Step: I join with a different user to that same room
  Roles:
    - Role: desktopChrome2
      Capabilities:
        chromeOptions:
          args:
            - use-fake-ui-for-media-stream
            - use-fake-device-for-media-stream
            - no-sandbox
      App: desktop
  Actions:
    - Type: navigate
      Role: desktopChrome2
      Value: https://appr.tc/r/$AND_CLI_LINK_ID$
    - Type: click
      Strategy: css
      Id: "[id=\"confirm-join-button\"]"
    - Type: minimize

Recordings:
  Step: I start recording audio, video and traces
  Roles:
    - Role: commandLine
      App: command
  Actions:
    - Type: command
      Value: "tshark -Q -i \"$AND_CLI_INTERFACE$\" -w trace.pcapng -a duration:$AND_CLI_TIME$"
      Detach: true
    - Type: command
      Value: "sox -q -r 44100 -t coreaudio \"default\" call.wav trim 0 $AND_CLI_TIME$"
      Detach: true
    - Type: command
      Value: "ffmpeg -v quiet -y -f avfoundation -t $AND_CLI_TIME$ -i \"$AND_CLI_VIDEO_IN$:\" output.mkv"

Analysis:
  Step: I start analysing audio, video and traces
  Roles:
    - Role: commandLine
      App: command
  Actions:
    - Type: command
      Value: sox call.wav -b 16 call_16b.wav
    - Type: command
      Value: docker run --rm -v $AND_CMD_pwd$:/home alvarolaserna/visqol:1.0 ./visqol.sh /home/call_16b.wav /home/call_16b.wav > mox_logs.txt
    - Type: command
      Value: docker run --rm -v $AND_CMD_pwd$:/home alvarolaserna/visqol:1.0 ./visqol.sh /home/call_16b.wav /home/call_16b.wav
      Greps:
        - var: SOME_VAR
          condition: nempty
          remove: "MOS-LQO:\t\t"
          match: "MOS-LQO:\t\t(.*)"
    - Type: command
      Value: echo $AND_CLI_SOME_VAR$ > mos.txt
    - Type: command
      Value: tshark -r trace.pcapng -qz io,stat,1 > trace.txt

CaseAppr:
  Vars:
    TIME: 10
    INTERFACE: en0
    VIDEO_IN: "3"
  Roles:
    - Role: desktopChrome,desktopChrome2
      Capabilities:
        chromeOptions:
          args:
            - use-fake-ui-for-media-stream
            - use-fake-device-for-media-stream
            - no-sandbox
            - use-file-for-fake-audio-capture=/user/silence.wav
            - use-file-for-fake-video-capture=/Users/alvarolaserna/Documents/ref_video.mjpeg
      App: desktop
    - Role: commandLine
      App: command
  Actions:
    - Given: I navigate to appr page
    - Then: I create a room
    - And: I join with a different user to that same room
    - Given: I start recording audio, video and traces
    - Then: I start analysing audio, video and traces


